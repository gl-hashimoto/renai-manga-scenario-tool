# パターン化問題の改善案（面白さ×バリエーション×回避）

## 🎯 目標

1. **パターン化の回避**：よくあるエンディングパターンを避ける
2. **面白さの維持**：ストーリーの面白さ・感動・共感をキープ
3. **バリエーションの確保**：毎回異なる魅力的なエンディングを生成

---

## 🔍 現状の問題パターン

### 検出されたパターン
1. **夫婦仲直り系**：夕暮れを2人で歩く
2. **離婚系**：新居で窓から差し込む光と前向きな言葉
3. **その他想定されるパターン**：
   - 桜の下での告白
   - 雨の中で抱き合う
   - 海辺で2人のシルエット
   - コーヒーショップでの再会

---

## 💡 解決アプローチ

### 1. エンディングバリエーションシステムの構築

#### 1-1. エンディングタイプの分類
**状況別エンディングパターン**を用意し、ランダムに選択：

```
【仲直り系】のバリエーション：
1. キッチンで一緒に料理を作る日常シーン
2. バスルームで歯を磨きながら軽い会話
3. ソファで映画を見ながら肩を寄せ合う
4. ベランダで夜風に当たりながら将来の話
5. スーパーで食材を選ぶ何気ない日常
6. 散歩道で手をつないで歩く（夕暮れ以外）

【離婚・新しいスタート系】のバリエーション：
1. 新しい職場での同僚との会話
2. 趣味のサークルでの新しい出会い
3. 子どもと公園で遊ぶ日常
4. 一人で美味しいご飯を食べるシーン
5. 友達とカフェで笑い合うシーン
6. 新しい目標に向かって勉強する姿

【成就系】のバリエーション：
1. 朝の目覚めと「おはよう」のセリフ
2. 通勤電車で一緒にスマホを見る
3. コンビニで一緒にお菓子を選ぶ
4. 家事を分担して効率的に済ませる
5. 夜、ベッドで軽い会話をして眠る
6. 週末、一緒に家で過ごす穏やかな時間
```

#### 1-2. パターン検出機能
**よくあるパターンを検出し、避ける仕組み**：

```python
COMMON_PATTERNS = [
    "夕暮れ.*歩",
    "窓.*光.*前向き",
    "桜.*下.*告白",
    "雨.*抱き合",
    "海辺.*シルエット",
    "コーヒーショップ.*再会"
]

def detect_pattern(scenario_text):
    """よくあるパターンを検出"""
    for pattern in COMMON_PATTERNS:
        if re.search(pattern, scenario_text):
            return True, pattern
    return False, None
```

---

### 2. 面白さを保ちつつバリエーションを出す方法

#### 2-1. エンディング生成の3ステップアプローチ

**ステップ1：状況の分析**
- ストーリーの状況を分析（仲直り/離婚/成就/再会など）
- 主人公の感情状態を把握
- 読者が感じたい感情を特定

**ステップ2：バリエーション候補の生成**
- 状況に応じた3-5個のエンディング候補を生成
- パターン化したものは除外
- 面白さ・感動・共感要素を各候補に含める

**ステップ3：最適な選択**
- ストーリーの流れに最も自然なものを選択
- ただし、最近使用したパターンは避ける
- 面白さ・インパクト・共感度で評価

#### 2-2. 面白さ要素の確保方法

**各エンディングに必須要素**：
1. **感情の回収**：ストーリー全体の感情が適切に回収されている
2. **共感ポイント**：読者が「わかる！」と思える要素
3. **インパクト**：印象に残るセリフ・シーン
4. **未来への示唆**：続きがありそうな、または完結した満足感

**例：離婚系のエンディング**
```
❌ パターン化（避ける）：
「新居の窓から差し込む光。B美「これからがスタートよ」」

✅ バリエーション1（面白さキープ）：
「B美が一人で夕食を作る。D太「ママのご飯美味しい」※笑顔
B美「当たり前でしょ」※軽く笑う
※B美のスマホにA子からのメッセージ『今週末、久しぶりに会おう』
B美「うん、楽しみ」※前を見つめる」

✅ バリエーション2（面白さキープ）：
「新しい職場でB美が同僚と笑顔で会話
同僚「B美さん、最近明るいね」
B美「そう？特別何かしたわけじゃないけど」
※B美の心の中『特別じゃない毎日が、特別だと思えるようになった』」
```

---

### 3. プロンプトへの組み込み

#### 3-1. マスタープロンプトへの追加セクション

```
## 【エンディングの多様化と面白さの両立】

### エンディング作成の原則

**1. パターン化の回避【必須】**
以下のようなよくあるパターンは絶対に避けてください：
- ❌ 夕暮れを2人で歩く（夫婦仲直り系）
- ❌ 新居で窓から差し込む光と前向きな言葉（離婚系）
- ❌ 桜の下での告白
- ❌ 雨の中で抱き合う
- ❌ 海辺で2人のシルエット
- ❌ コーヒーショップでの再会

**2. 面白さ要素の確保【必須】**
エンディングには必ず以下を含めてください：
- ✅ 感情の完全な回収（ストーリー全体の感情が適切に解決）
- ✅ 読者の共感ポイント（「わかる！」と思える要素）
- ✅ 印象に残るセリフまたはシーン
- ✅ 未来への示唆（続きがありそう、または完結した満足感）

**3. バリエーションの生成【必須】**
以下のアプローチで毎回異なるエンディングを考えてください：

【仲直り・和解系】の場合：
- 日常の何気ないシーンで関係性の回復を示す
- キッチン、リビング、散歩など、夕暮れ以外の場所・時間帯
- 言葉よりも行動で示す
- 例：一緒に料理、家事を分担、肩を寄せ合ってテレビを見る

【離婚・新しいスタート系】の場合：
- 新しい日常の小さな幸せを示す
- 窓からの光以外の視覚的要素（料理、公園、新しい場所）
- 一人でも充実している、または新しいつながり
- 例：一人で美味しいご飯、子どもとの時間、新しい友達との会話

【恋愛成就系】の場合：
- 特別な場所ではなく、日常の幸せを示す
- 告白シーンではなく、関係性の深まり
- 例：朝の目覚め、通勤時の会話、一緒に過ごす日常

**4. エンディング生成のステップ**
1. ストーリーの状況を分析（何が解決されたか）
2. 主人公の感情状態を把握（どんな気持ちで終わるか）
3. 読者が感じたい感情を特定（感動？爽快感？共感？）
4. パターン化したエンディングを避けつつ、3-5個の候補を考える
5. ストーリーの流れに最も自然で、かつ面白いものを選択
6. 感情の回収、共感ポイント、インパクト、未来への示唆を確認

**5. エンディングの文字数**
- 後編ラストは2-3コマ程度
- 簡潔かつ印象的
- ポエム調や文学調は避ける
- 日常的な会話や行動で締める
```

#### 3-2. リライト時のパターン検出と修正

リライトプロンプトに以下を追加：
```
【エンディングパターンチェック】
生成したエンディングが以下のパターンに該当していないか確認してください：
- 夕暮れを2人で歩く
- 新居で窓から差し込む光と前向きな言葉
- 桜の下での告白
- 雨の中で抱き合う
- その他よくあるパターン

もし該当する場合は、以下の要素を保ちつつ、異なるエンディングに変更してください：
- 感情の回収（維持）
- 読者の共感ポイント（維持）
- 印象に残る要素（別のアプローチで）
- 未来への示唆（維持）

面白さや感動を損なわずに、バリエーションのあるエンディングを生成してください。
```

---

## 🛠️ 実装計画

### Phase 1: プロンプト改善（最優先）

1. **マスタープロンプトにエンディング多様化セクションを追加**
   - パターン回避の明確な指示
   - 面白さ要素の確保方法
   - バリエーション生成のアプローチ
   - エンディング生成のステップ

2. **リライトプロンプトにパターン検出機能を追加**
   - パターン検出の指示
   - パターン検出時の修正方法

### Phase 2: パターン検出機能の実装

1. **パターン検出関数の実装**
   ```python
   def detect_ending_pattern(scenario_text):
       """よくあるエンディングパターンを検出"""
       patterns = [
           ("夕暮れ.*歩", "夕暮れ散歩パターン"),
           ("窓.*光.*前向き", "窓からの光パターン"),
           # ... その他のパターン
       ]
       for pattern, name in patterns:
           if re.search(pattern, scenario_text):
               return True, name
       return False, None
   ```

2. **パターン検出時の自動修正**
   - パターンを検出したら、自動的に別のバリエーションを提案
   - 面白さ要素を維持しつつ変更

### Phase 3: バリエーション生成機能（オプション）

1. **エンディング候補生成機能**
   - 状況に応じた3-5個の候補を生成
   - パターン化したものを除外
   - 最も面白いものを選択

2. **履歴からのパターン回避**
   - 最近使用したエンディングパターンを記録
   - 重複を避ける

---

## ✅ 期待される効果

1. **パターン化の回避**：よくあるパターンが大幅に減少
2. **面白さの維持**：感情の回収、共感ポイント、インパクトを確保
3. **バリエーションの確保**：毎回異なる魅力的なエンディング
4. **読者満足度の向上**：新鮮さと面白さの両立

---

## 📝 実装TODO

- [ ] マスタープロンプトにエンディング多様化セクションを追加
- [ ] リライトプロンプトにパターン検出機能を追加
- [ ] パターン検出関数を実装
- [ ] パターン検出時の自動修正機能を実装
- [ ] テスト：複数のシナリオを生成し、パターン化を確認
- [ ] テスト：面白さが維持されているか確認
- [ ] テスト：バリエーションが確保されているか確認

