# フィードバック対応提案とTODO

## 📋 フィードバック内容の整理

### 1. 視点変更が効かない
**問題**：
- 体験談から親友目線側に変更したいが、「親友目線のストーリーに変更」というオプションを追加しても機能しない
- 生成されたシナリオが体験談そのままの視点になっている

**原因分析**：
- UIに視点選択のオプションがない
- プロンプトに視点変更に関する明確な指示がない
- 追加の要望欄に書いても、システムプロンプトに組み込まれていないため反映されにくい

### 2. 文字数が多い
**問題**：
- 生成されたシナリオが文字数制限を超えている
- リライト時にもチェックがあるが、それでもオーバーしている

**原因分析**：
- 文字数制限の指示が生成プロンプトにあるが、実際の文字数カウントとずれている可能性
- リライト時の文字数チェックが十分に厳格ではない

### 3. パターン化の問題
**問題**：
- 夫婦仲直りする場合：ラストで夕暮れを2人で歩く出力の確率が高い
- 夫婦別れた場合：妻が新居で窓から差し込む光と共に前向きな言葉で〆る確率が多い

**原因分析**：
- エンディングのパターンが学習データに多く含まれている
- プロンプトに「パターン化を避ける」という指示がない

---

## 🔧 解決策と実装計画

### 【優先度：高】1. 視点変更機能の実装

#### 1-1. UIに視点選択オプションを追加
**実装内容**：
- サイドバーに「視点の選択」セクションを追加
- 選択肢：
  - 主人公目線（デフォルト）
  - 親友・友人目線
  - 第三者の視点
  - 体験談から自動変換（親友目線推奨）

**実装場所**：
- `app.py`のサイドバー設定部分
- `generate_scenario`関数に`viewpoint`パラメータを追加

#### 1-2. 視点変更用のプロンプトテンプレート作成
**実装内容**：
- 各視点に応じたプロンプトテンプレートを作成
- 特に「体験談→親友目線」の変換パターンを明確化

**プロンプトテンプレート例**：
```
【視点変更指示】
以下の体験談を、{選択した視点}のストーリーに変換してください。

【視点変更のポイント】
- 体験談の内容は維持しつつ、視点のみを変更
- {視点の人物}の目線で語られるストーリーにする
- {視点の人物}の感情・行動・思考を中心に描写
- 元の体験談の人物は登場人物として扱う
```

#### 1-3. プロンプトに視点指示を組み込む
**実装内容**：
- マスタープロンプトに視点に関するセクションを追加
- `generate_scenario`関数で視点情報をプロンプトに組み込む
- リライト時にも視点を維持する指示を追加

---

### 【優先度：高】2. 文字数制限の強化

#### 2-1. リライト時の文字数チェック強化
**実装内容**：
- リライト後に文字数を再計算
- オーバーしている場合は、短縮プロンプトで再度リライト
- 最大3回まで短縮リライトを試行

**実装ロジック**：
```python
def enforce_char_limit(api_key, scenario, max_retries=3):
    for i in range(max_retries):
        char_count = count_characters(scenario)
        if char_count <= 1200:  # 制限内
            return scenario
        else:
            # 短縮リライト
            scenario = shorten_scenario(api_key, scenario)
    return scenario
```

#### 2-2. 生成時の文字数ガイドライン強化
**実装内容**：
- プロンプトに「絶対に600/600/1200文字を超えない」という強調を追加
- 生成前に文字数目標を明確に指定
- 短い文章を推奨する例を追加

#### 2-3. 文字数カウント関数の精度向上
**実装内容**：
- 現在の`count_characters`関数を確認
- カウント方法がプロンプトと一致しているか確認
- 必要に応じてカウントロジックを修正

---

### 【優先度：中】3. パターン化の回避

#### 3-1. エンディングパターン回避の指示を追加
**実装内容**：
- マスタープロンプトに「エンディングパターンの回避」セクションを追加
- よくあるパターンを列挙し、避けるように指示

**追加するプロンプト内容**：
```
【エンディングの多様化】
以下のようなパターン化されたエンディングは避けてください：

❌ 避けるべきパターン：
- 夫婦仲直り→夕暮れを2人で歩く
- 夫婦別れた→新居で窓から差し込む光と前向きな言葉
- 片思い成就→桜の下での告白
- 三角関係解決→雨の中で抱き合う

✅ 推奨するアプローチ：
- エンディングは毎回異なる展開を考える
- 状況に応じた自然な終わり方
- 読者を飽きさせない多様性のある結末
- シンプルかつ印象的な締めくくり
```

#### 3-2. リライト時にパターン検出機能を追加
**実装内容**：
- リライト時に既存のパターンがないかチェック
- パターンを検出した場合は、別のエンディングを提案

---

## 📝 TODOリスト

### Phase 1: 視点変更機能の実装（優先度：高）

- [ ] **UIに視点選択オプション追加**
  - [ ] サイドバーに「視点の選択」セクションを追加
  - [ ] 選択肢：主人公目線/親友目線/第三者の視点/自動変換
  - [ ] デフォルトは「主人公目線」
  
- [ ] **視点変更用プロンプトテンプレート作成**
  - [ ] 各視点のプロンプトテンプレートを作成
  - [ ] 「体験談→親友目線」変換用のテンプレート
  - [ ] `prompts/`ディレクトリに保存
  
- [ ] **generate_scenario関数の拡張**
  - [ ] `viewpoint`パラメータを追加
  - [ ] 視点に応じたプロンプトを組み立て
  - [ ] 視点情報を履歴に保存
  
- [ ] **リライト時の視点維持**
  - [ ] リライト時にも視点情報を引き継ぐ
  - [ ] 視点が変わらないようプロンプトに指示

### Phase 2: 文字数制限の強化（優先度：高）

- [ ] **リライト時の文字数チェック強化**
  - [ ] `enforce_char_limit`関数を実装
  - [ ] オーバー時に自動短縮リライト
  - [ ] 最大3回までリトライ
  
- [ ] **短縮リライト関数の実装**
  - [ ] `shorten_scenario`関数を作成
  - [ ] 冗長な表現を削除するプロンプト
  
- [ ] **プロンプトの文字数ガイドライン強化**
  - [ ] マスタープロンプトの文字数制限を強調
  - [ ] 短い文章の例を追加
  - [ ] 文字数オーバーを防ぐ具体的な指示

- [ ] **文字数カウント関数の検証**
  - [ ] 現在の`count_characters`関数を確認
  - [ ] プロンプトのカウント方法と一致しているか検証
  - [ ] 必要に応じて修正

### Phase 3: パターン化の回避（優先度：中）

- [ ] **エンディングパターン回避の指示追加**
  - [ ] マスタープロンプトに回避パターンのセクションを追加
  - [ ] よくあるパターンを列挙
  - [ ] 多様性を促す指示
  
- [ ] **リライト時のパターン検出機能**
  - [ ] よくあるパターンをリスト化
  - [ ] リライト時にパターンを検出
  - [ ] 検出時は別のエンディングを提案

### Phase 4: テストと検証

- [ ] **視点変更機能のテスト**
  - [ ] 各視点でシナリオ生成をテスト
  - [ ] 視点が正しく反映されているか確認
  
- [ ] **文字数制限のテスト**
  - [ ] 様々なテーマで生成し、文字数が制限内か確認
  - [ ] オーバー時の自動短縮が機能するか確認
  
- [ ] **パターン化回避のテスト**
  - [ ] 複数のシナリオを生成し、エンディングの多様性を確認
  - [ ] パターン化が減少したか検証

---

## 🎯 実装の優先順位

1. **最優先**：視点変更機能の実装（ユーザーが直接要望している機能）
2. **高優先**：文字数制限の強化（品質に関わる問題）
3. **中優先**：パターン化の回避（長期的な品質向上）

---

## 📌 実装時の注意点

1. **視点変更機能**：
   - 体験談を入力した場合、自動的に「親友目線」を推奨する
   - 視点変更後もストーリーの内容は維持する
   - 視点の人物の感情・行動・思考を中心に描写する

2. **文字数制限**：
   - 文字数を削減する際、内容の質を落とさない
   - 冗長な表現を削り、簡潔かつインパクトのある表現に
   - 文字数チェックは厳格に行うが、読みやすさも重視

3. **パターン化回避**：
   - よくあるパターンを完全に禁止するのではなく、多様性を促す
   - 状況に応じた自然なエンディングを推奨
   - 読者を飽きさせない多様性のある結末を目指す

